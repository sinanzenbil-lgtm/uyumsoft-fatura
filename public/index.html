<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finans Y√∂netim Sistemi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .navbar {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .nav-menu { display: flex; gap: 10px; }
        .nav-btn {
            background: transparent;
            color: #8892b0;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .nav-btn:hover { border-color: #00d2ff; color: #00d2ff; }
        .nav-btn.active {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: #fff;
            border: none;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .section-header { text-align: center; margin-bottom: 30px; }
        .section-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .section-header p { color: #8892b0; }
        .provider-badge {
            background: linear-gradient(90deg, #ff6b6b, #ffa502);
            color: #fff;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-block;
            margin-top: 10px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 25px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-header h2 { color: #e6f1ff; font-size: 1.2rem; }
        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label {
            display: block;
            color: #8892b0;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
        }
        .form-group input:focus { outline: none; border-color: #00d2ff; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn {
            padding: 12px 25px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: #8892b0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab-btn:hover { border-color: #00d2ff; color: #00d2ff; }
        .tab-btn.active {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: #fff;
            border: none;
        }
        .btn {
            padding: 12px 30px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: #fff;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(58,123,213,0.4);
        }
        .btn-outline {
            background: transparent;
            color: #00d2ff;
            border: 1px solid #00d2ff;
        }
        .btn-outline:hover { background: #00d2ff; color: #1a1a2e; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-card h4 {
            color: #8892b0;
            font-size: 0.8rem;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .stat-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        th {
            background: rgba(255,255,255,0.03);
            color: #8892b0;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        tr:hover { background: rgba(255,255,255,0.02); }
        td { color: #e6f1ff; font-size: 0.9rem; }
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        .alert.show { display: block; }
        .alert-error { background: rgba(255,71,87,0.2); border: 1px solid #ff4757; color: #ff4757; }
        .alert-success { background: rgba(0,255,136,0.2); border: 1px solid #00ff88; color: #00ff88; }
        .loading { display: none; text-align: center; padding: 40px; }
        .loading.active { display: block; }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #00d2ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover { border-color: #3a7bd5; background: rgba(58,123,213,0.1); }
        .upload-icon { font-size: 3rem; margin-bottom: 15px; }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status-approved { background: rgba(0,255,136,0.2); color: #00ff88; }
        .status-pending { background: rgba(255,165,0,0.2); color: #ffa500; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">üíº Finans Y√∂netim</div>
        <div class="nav-menu">
            <button class="nav-btn" onclick="showPage('ekstrem', this)">üìä Banka Ekstresi</button>
            <button class="nav-btn active" onclick="showPage('fatura', this)">üßæ E-Fatura</button>
        </div>
    </nav>

    <div class="container">
        <!-- Banka Ekstresi -->
        <div id="ekstrem" class="page-section">
            <div class="section-header">
                <h1>üìä Banka Ekstresi Analiz</h1>
                <p>PDF dosyanƒ±zƒ± y√ºkleyin, i≈ülem detaylarƒ±nƒ± otomatik √ßƒ±karalƒ±m</p>
            </div>
            <div class="card">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìÑ</div>
                    <h3>PDF Dosyasƒ± Y√ºkle</h3>
                    <p style="color:#8892b0; margin:10px 0;">Banka ekstrenizi s√ºr√ºkleyip bƒ±rakƒ±n veya tƒ±klayƒ±n</p>
                    <input type="file" id="fileInput" style="display:none;" accept=".pdf">
                </div>
            </div>
        </div>

        <!-- E-Fatura -->
        <div id="fatura" class="page-section active">
            <div class="section-header">
                <h1>üßæ E-Fatura Y√∂netimi</h1>
                <p>Uyumsoft √ºzerinden faturalarƒ±nƒ±zƒ± sorgulayƒ±n</p>
                <span class="provider-badge">Uyumsoft</span>
            </div>

            <div class="alert alert-error" id="faturaError"></div>
            <div class="alert alert-success" id="faturaSuccess"></div>

            <div class="card">
                <div class="card-header">
                    <h2>üìÖ Fatura Sorgulama</h2>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Ba≈ülangƒ±√ß Tarihi</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label>Biti≈ü Tarihi</label>
                        <input type="date" id="endDate">
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="setFaturaType('gelen', this)">üì• Gelen Faturalar</button>
                    <button class="tab-btn" onclick="setFaturaType('giden', this)">üì§ Giden Faturalar</button>
                </div>

                <button class="btn btn-primary" onclick="queryFaturalar()">üîç Faturalarƒ± Getir</button>
            </div>

            <div class="loading" id="faturaLoading">
                <div class="spinner"></div>
                <p>Faturalar sorgulanƒ±yor...</p>
            </div>

            <div id="faturaResults" style="display:none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Bulunan Fatura</h4>
                        <div class="value" id="faturaCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Toplam Tutar</h4>
                        <div class="value" id="faturaToplam">‚Ç∫0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Toplam KDV</h4>
                        <div class="value" id="faturaKdv">‚Ç∫0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 id="faturaTableTitle">Gelen Faturalar</h2>
                        <button class="btn btn-outline" onclick="exportCSV()">üì• CSV ƒ∞ndir</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fatura No</th>
                                    <th>Tarih</th>
                                    <th>Firma</th>
                                    <th>Tutar</th>
                                    <th>KDV</th>
                                    <th>Toplam</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody id="faturaTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFaturaType = 'gelen';
        let faturaData = [];

        // Varsayƒ±lan tarihleri ayarla (son 30 g√ºn)
        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        }
        setDefaultDates();

        function showPage(pageId, btn) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            btn.classList.add('active');
        }

        function setFaturaType(type, btn) {
            currentFaturaType = type;
            document.querySelectorAll('.tabs .tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        async function queryFaturalar() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                showAlert('error', 'L√ºtfen tarih aralƒ±ƒüƒ± se√ßin');
                return;
            }

            document.getElementById('faturaLoading').classList.add('active');
            document.getElementById('faturaResults').style.display = 'none';
            hideAlerts();

            const endpoint = currentFaturaType === 'gelen' ? '/api/gelen' : '/api/giden';

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        startDate: startDate + 'T00:00:00.000',
                        endDate: endDate + 'T23:59:59.999'
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'API hatasƒ±');
                }

                faturaData = data.invoices || [];
                displayFaturaResults(faturaData);
                showAlert('success', faturaData.length + ' fatura bulundu');

            } catch (error) {
                showAlert('error', 'Hata: ' + error.message);
            } finally {
                document.getElementById('faturaLoading').classList.remove('active');
            }
        }

        function displayFaturaResults(invoices) {
            const tbody = document.getElementById('faturaTable');
            tbody.innerHTML = '';

            document.getElementById('faturaTableTitle').textContent = 
                currentFaturaType === 'gelen' ? 'Gelen Faturalar' : 'Giden Faturalar';

            if (invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#8892b0;">Fatura bulunamadƒ±</td></tr>';
                document.getElementById('faturaCount').textContent = '0';
                document.getElementById('faturaToplam').textContent = '‚Ç∫0';
                document.getElementById('faturaKdv').textContent = '‚Ç∫0';
            } else {
                let totalAmount = 0, totalKdv = 0;

                invoices.forEach(inv => {
                    const row = document.createElement('tr');
                    
                    const date = inv.invoiceDate ? inv.invoiceDate.split('T')[0] : '-';
                    const firma = inv.senderName || inv.receiverName || '-';
                    const statusClass = inv.status === 'Onaylandƒ±' ? 'status-approved' : 'status-pending';
                    
                    totalAmount += inv.amount || 0;
                    totalKdv += inv.taxAmount || 0;

                    row.innerHTML = 
                        '<td>' + inv.invoiceNumber + '</td>' +
                        '<td>' + date + '</td>' +
                        '<td>' + firma + '</td>' +
                        '<td>' + formatCurrency(inv.amount) + '</td>' +
                        '<td>' + formatCurrency(inv.taxAmount) + '</td>' +
                        '<td>' + formatCurrency(inv.totalAmount) + '</td>' +
                        '<td><span class="status-badge ' + statusClass + '">' + inv.status + '</span></td>';
                    
                    tbody.appendChild(row);
                });

                document.getElementById('faturaCount').textContent = invoices.length;
                document.getElementById('faturaToplam').textContent = formatCurrency(totalAmount);
                document.getElementById('faturaKdv').textContent = formatCurrency(totalKdv);
            }

            document.getElementById('faturaResults').style.display = 'block';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(amount || 0);
        }

        function showAlert(type, message) {
            hideAlerts();
            const alertEl = document.getElementById(type === 'error' ? 'faturaError' : 'faturaSuccess');
            alertEl.textContent = message;
            alertEl.classList.add('show');
        }

        function hideAlerts() {
            document.getElementById('faturaError').classList.remove('show');
            document.getElementById('faturaSuccess').classList.remove('show');
        }

        function exportCSV() {
            if (faturaData.length === 0) {
                alert('ƒ∞ndirilecek veri yok');
                return;
            }

            const headers = ['Fatura No', 'Tarih', 'Firma', 'Tutar', 'KDV', 'Toplam', 'Durum'];
            const rows = faturaData.map(inv => [
                inv.invoiceNumber,
                inv.invoiceDate ? inv.invoiceDate.split('T')[0] : '',
                inv.senderName || inv.receiverName || '',
                inv.amount,
                inv.taxAmount,
                inv.totalAmount,
                inv.status
            ]);

            let csv = headers.join(';') + '\n';
            rows.forEach(row => { csv += row.join(';') + '\n'; });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'faturalar_' + currentFaturaType + '.csv';
            link.click();
        }
    </script>
</body>
</html>
